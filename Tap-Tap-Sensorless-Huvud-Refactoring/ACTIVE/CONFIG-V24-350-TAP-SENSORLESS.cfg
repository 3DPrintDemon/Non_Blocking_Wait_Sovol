#https://docs.vorondesign.com/community/howto/clee/sensorless_xy_homing.html
#https://www.klipper3d.org/TMC_Drivers.html#sensorless-homing

#.................................................................................................................
[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 3000
max_z_velocity: 15 
max_z_accel: 350
square_corner_velocity: 5.0

[exclude_object]
# Allows Klipper to exclude objects while a print is in progress

[virtual_sdcard]
path: ~/printer_data/gcodes                                ; Path to store gcodes

[display_status]
# For mainsail

[pause_resume]
# For mainsail

[respond]
default_type: echo                                         ; Default respond type

[idle_timeout]
timeout: 1800                                              ; Idle timeout in seconds

[force_move]
enable_force_move: true                                    ; Enable force move



#.................................................................................................................
[probe]
# Voron-TAP_Probe on Huvud
pin: huvud:PB11
x_offset: 0
y_offset: 0
z_offset: -0.55
speed: 5.0
lift_speed: 5.0
samples: 4
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.010
samples_tolerance_retries: 5

# Active code follows that prevents probing bed with high nozzle temp, cutoff temp will be as defined by 'extruder_warm'
# setting in main printer.cfg file.
activate_gcode:
    {% set PROBE_TEMP = printer["gcode_macro _PRINT_VARIABLES"].extruder_warm|float %} ; Get extruder_warm from _PRINT_VARIABLES
    {% set MAX_TEMP = PROBE_TEMP + 5 %}                                                ; Set max temp to 5C above extruder_warm
    {% set ACTUAL_TEMP = printer.extruder.temperature %}                               ; Get actual extruder temp
    {% set TARGET_TEMP = printer.extruder.target %}                                    ; Get target extruder temp
    {% if TARGET_TEMP > PROBE_TEMP %}                                                  ; If target temp is higher than extruder_warm
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) } ; Print message
        M104 S{ PROBE_TEMP }                                                           ; Set extruder temp to extruder_warm
        _COOL_WAIT MINUTES=2 NZL_TEMP={ MAX_TEMP }                                     ; Wait for temp to drop to max temp
    {% else %}                                                                         ; If target temp is lower than extruder_warm
        {% if ACTUAL_TEMP > MAX_TEMP %}                                                ; If actual temp is higher than max temp
            { action_respond_info('Extruder temperature %.1fC is too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) } ; Print message
            M104 S{ PROBE_TEMP }                                                       ; Set extruder temp to extruder_warm
            _COOL_WAIT MINUTES=2 NZL_TEMP={ MAX_TEMP }                                 ; Wait for temp to drop to max temp
        {% endif %}                                                                    ; End if actual temp is higher than max temp
    {% endif %}                                                                        ; End if target temp is higher than extruder_warm



#.................................................................................................................
[homing_override]
axes: xyz
gcode:
    STATUS_HOMING                                          ; Set status to homing
    SET_NOZZLE_LEDS_ON                                     ; Turn on nozzle LEDs
    {% set X_MID = printer.configfile.config["stepper_x"]["position_max"]|float / 2.0 %} ; Get X midpoint
    {% set Y_MID = printer.configfile.config["stepper_y"]["position_max"]|float / 2.0 %} ; Get Y midpoint
	{% set X_MeshCenter, Y_MeshCenter = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center.split(',')|map('trim')|map('int') %} ; Get mesh center
    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %} ; Check if all axes are being homed
    {% set Z_POS = printer.toolhead.position.z %}          ; Get current Z position

#   If Z-axis is not homed, a full homed sequence will be run. Comment out the 'Safety On' line below if this is not desired.
    {% if "z" not in printer.toolhead.homed_axes %}        ; Check if Z not already homed
        {% set home_all = 'Safety On' %}                   ; ! THIS WILL HOME ALL AXIS IF Z IS NOT HOMED, COMMENT OUT IF THIS IS NOT DESIRED !
        SET_KINEMATIC_POSITION Z=0                         ; Reset Z position to 0
        G0 Z10 F3600                                       ; Raise toolhead 10mm since unknown/not homed
      {% else %}                                           ; IF Z is already homed
        {% if Z_POS < 10 %}                                ; Check if Z is below 10mm
            G90                                            ; Absolute positioning
            G0 Z10                                         ; If Z was below 10mm, raise to 10mm for safety
          {% else %}                                       ; IF Z is already above 10mm
            G91                                            ; Relative positioning
            G0 Z1 F3600                                    ; If Z was above 10mm, raise by 1mm for safety
            G90                                            ; Absolute positioning
        {% endif %}                                        ; End Z position check
    {% endif %}                                            ; End Z homed check


    {% if home_all or 'X' in params %}                     ; If 'home_all' is set, or 'X' is in params, then home X
        _HOME_X                                            ; Home X
    {% endif %}                                            ; End X homing check

    {% if home_all or 'Y' in params %}                     ; If 'home_all' is set, or 'Y' is in params, then home Y
        _HOME_Y                                            ; Home Y
    {% endif %}                                            ; End Y homing check
  
    {% if home_all or 'Z' in params %}                     ; If 'home_all' is set, or 'Z' is in params, then home Z
        G90                                                ; Absolute positioning
        {% if X_MeshCenter > 0 and Y_MeshCenter > 0 %}     ; If mesh center is set, use it
            G0 X{X_MeshCenter} Y{Y_MeshCenter} F4000       ; Move to mesh center    
          {% else %}                                       ; If mesh center is not set, use printer center
            G0 X{X_MID} Y{Y_MID} F4000                     ; Move to printer center
        {% endif %}                                        ; End mesh center check
        G28 Z                                              ; Home Z
        G1 Z10 F3600                                       ; Raise toolhead 10mm
    {% endif %}                                            ; End Z homing check

    STATUS_READY                                           ; Set status to ready
    SET_NOZZLE_LEDS_ON                                     ; Turn on nozzle LEDs	



#.................................................................................................................
[gcode_macro _HOME_X]
gcode:
    {% set RUN_CURRENT_X = printer['tmc2209 stepper_x'].run_current|float %} ; Get current X run current
    {% set RUN_CURRENT_Y = printer['tmc2209 stepper_y'].run_current|float %} ; Get current Y run current
    {% set HOME_CURRENT = 0.7 %}                                             ; Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}                 ; Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}                 ; Set current for sensorless homing

    G28 X                                                                    ; Home X
    G91                                                                      ; Relative positioning
    G1 X-10 F1200                                                            ; Move X 10mm away
    
    G4 P1000                                                                 ; Wait 1 second to give StallGuard registers time to clear
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}                ; Set current to previous
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}                ; Set current to previous



#.................................................................................................................
[gcode_macro _HOME_Y]
gcode:
    {% set RUN_CURRENT_X = printer['tmc2209 stepper_x'].run_current|float %} ; Get current X run current
    {% set RUN_CURRENT_Y = printer['tmc2209 stepper_y'].run_current|float %} ; Get current Y run current
    {% set HOME_CURRENT = 0.7 %}                                             ; Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}                 ; Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}                 ; Set current for sensorless homing

    G28 Y                                                                    ; Home Y
    G91                                                                      ; Relative positioning
    G1 Y-10 F1200                                                            ; Move Y 10mm away

    G4 P1000                                                                 ; Wait 1 second to give StallGuard registers time to clear
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}                ; Set current to previous
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}                ; Set current to previous  



#.................................................................................................................
[quad_gantry_level]
# Leveling code for XY rails that are controlled by Z steppers as in:
#
#                        TOP / Overhead View
#
#                           -=- Front -=-
#
# Z stepper3 ----> O                             O <---- Z stepper0
#                  | * <-- Probe3   Probe0 --> * |       X-051/Y006
#                  |    X300/Y050   X050/Y050    |
#                  |                             | <--- Y2 rail
#   Y1 rail -----> |                             |
#                  |                             |
#                  |=============================|
#                  |            ^                |
#                  |            |                |
#                  |   X rail --/                |
#                  |                             |
#                  | * <-- Probe2   Probe1 --> * |
# Z stepper2 ----> O    X300/Y300   X050/Y300    O <---- Z stepper1
# X401/Y423

#                            -=- Rear -=-
gantry_corners:
   -51,6
   401,423
points:
   50,50
   50,300
   300,300
   300,50
speed: 100
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.01
max_adjust: 10



#.................................................................................................................
[bed_mesh]
speed: 100
horizontal_move_z: 3
mesh_min: 40, 40
mesh_max: 310,310
fade_start: 0.6
fade_end: 10.0
probe_count: 5,5
mesh_pps: 2,2
algorithm: bicubic



#.................................................................................................................
[gcode_macro G32]
gcode:
    BED_MESH_CLEAR                                         ; Clear bed-mesh
    G28                                                    ; Home
    QUAD_GANTRY_LEVEL                                      ; Quad gantry level
    G28 Z                                                  ; Home Z



#.................................................................................................................
[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: QUAD_GANTRY_LEVEL_ORIGINAL
description: Levels the four Z-axis gantry corners
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}          ; Home if not already homed
        G28                                                ; Home
    {% endif %}                                            ; End homing check
    STATUS_LEVELING                                        ; Set status to leveling
    SET_NOZZLE_LEDS_ON                                     ; Turn on nozzle LEDs
    QUAD_GANTRY_LEVEL_ORIGINAL                             ; Run original macro
    STATUS_READY                                           ; Set status to ready
    SET_NOZZLE_LEDS_ON                                     ; Turn on nozzle LEDs



#.................................................................................................................
[gcode_macro G3201]
description: Clears bed-mesh and performs G28, QGL, G28-Z, and applies bed-mesh
gcode:
    BED_MESH_CLEAR                                         ; Clear bed-mesh
    G28                                                    ; Home
    QUAD_GANTRY_LEVEL_ORIGINAL                             ; Quad gantry level
    G0 Z10 F3600                                           ; Raise toolhead 10mm
    G28 Z                                                  ; Home Z
    ADAPTIVE_BED_MESH                                      ; Run adaptive bed-mesh
    STATUS_READY                                           ; Set status to ready
    SET_NOZZLE_LEDS_ON                                     ; Turn on nozzle LEDs



#.................................................................................................................
[stepper_x]
# B Stepper - Left, Connected to MOTOR_0, Endstop connected to DIAG_0
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_endstop: 350
position_max: 350
homing_speed: 30   # safest is rotation_distance of 40 / 2 = 20
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: false
run_current: 0.4
sense_resistor: 0.105
stealthchop_threshold: 0
diag_pin: ^PG6
driver_SGTHRS: 80 # 255 is most sensitive value, 0 is least sensitive



#.................................................................................................................
[stepper_y]
# A Stepper - Right, Connected to MOTOR_1, Endstop connected to DIAG_1
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 350
position_max: 354
homing_speed: 30   # safest is rotation_distance of 40 / 2 = 20
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: false
run_current: 0.4
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG9
driver_SGTHRS: 80  # 255 is most sensitive value, 0 is least sensitive 



#.................................................................................................................
[stepper_z]
# Z0 Stepper - Front Left, Connected to MOTOR_2, Endstop connected to DIAG_2
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop
position_max: 301
position_min: -3
homing_speed: 10
second_homing_speed: 5
homing_retract_dist: 5

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 0


[stepper_z1]
# Z1 Stepper - Rear Left, Connected to MOTOR_3
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 0


[stepper_z2]
# Z2 Stepper - Rear Right, Connected to MOTOR_4
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 0


[stepper_z3]
# Z3 Stepper - Front Right, Connected to MOTOR_5
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 0